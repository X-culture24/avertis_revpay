# Revpay Connect eTIMS Gateway

**Certified 3rd-Party eTIMS Integrator for Kenya Revenue Authority**

A comprehensive multi-tenant Django backend solution that enables businesses to seamlessly integrate with Kenya Revenue Authority's eTIMS system through both **Online Sales Control Unit (OSCU)** and **Virtual Sales Control Unit (VSCU)** APIs. Built by **Revpay Connect Ltd**, this production-ready system provides complete tax compliance automation for diverse business systems across Kenya.

## ğŸ† KRA Certification Status
- âœ… **OSCU Certified Integrator** - Physical device integrations
- âœ… **VSCU Certified Integrator** - Virtual/API-only integrations  
- âœ… **Multi-System Support** - Comprehensive eTIMS coverage
- âœ… **Scalable Business Model** - Transaction-based and subscription revenue

## ğŸš€ Core Features

### ğŸ¢ Multi-Tenant Architecture
- **Company Management**: Complete client onboarding with automatic device registration
- **Secure Isolation**: Each business operates in its own secure environment
- **Subscription Plans**: Flexible pricing tiers for different business sizes
- **Environment Switching**: Seamless sandbox-to-production migration

### ğŸ” Enterprise Security
- **Data Encryption**: Military-grade encryption for sensitive CMC keys and credentials
- **Audit Logging**: Complete compliance trail with severity levels and user tracking
- **Token Authentication**: Secure API access with role-based permissions
- **Environment Isolation**: Strict separation between sandbox and production data

### ğŸ“Š Analytics & Monitoring
- **Real-time Dashboards**: Company-specific and system-wide analytics
- **Compliance Reports**: Automated daily, weekly, and monthly compliance reporting
- **Performance Metrics**: Transaction success rates, device uptime, and response times
- **Alert System**: Proactive notifications for failures, compliance issues, and system health

### ğŸ”„ Resilience & Recovery
- **Intelligent Retry Logic**: Exponential backoff with multi-tenant failure notifications
- **Offline Resilience**: Queue-based processing for network interruptions
- **Device Monitoring**: Automatic offline detection and alert notifications
- **Data Backup**: Automated cleanup and archival of historical data

### ğŸ”— Dual Integration Capabilities

#### ğŸ–¥ï¸ OSCU Integration (Online Sales Control Unit)
- **Physical Device Support**: Hardware-based POS integrations
- **Real-time Processing**: Direct KRA communication through certified devices
- **Receipt Management**: Physical receipt printing and validation
- **Offline Capabilities**: Queue-based processing during network interruptions

#### â˜ï¸ VSCU Integration (Virtual Sales Control Unit)  
- **API-Only Integration**: Cloud-based virtual device management
- **E-commerce Support**: Perfect for online stores and digital platforms
- **Mobile App Integration**: Seamless mobile application tax compliance
- **Webhook Notifications**: Real-time event-driven communications
- **Scalable Architecture**: Handle high-volume digital transactions

### ğŸ“± Notification System
- **Multi-Channel Alerts**: Email, SMS, webhook, and system notifications
- **Branded Communications**: Professional Revpay Connect email templates
- **Smart Routing**: Context-aware notification delivery based on severity
- **Notification History**: Complete audit trail of all communications

## ğŸ“‹ Prerequisites

- Python 3.11+
- PostgreSQL 12+
- Redis 6+
- Docker & Docker Compose (optional)

## ğŸ› ï¸ Quick Setup

### 1. Environment Setup

```bash
# Clone and navigate to project
cd etims_integration

# Create virtual environment
python -m venv venv
source venv/bin/activate  # Linux/Mac
# or
venv\Scripts\activate  # Windows

# Install dependencies
pip install -r requirements.txt
```

### 2. System Initialization

Initialize the Revpay Connect system with management commands:

```bash
# Initialize system (creates admin user, encryption keys, system codes)
python manage.py revpay_init_system --admin-email admin@yourcompany.com

# Setup periodic tasks for monitoring and maintenance
python manage.py setup_celery_beat

# Run system health check
python manage.py revpay_status_check --verbose
```

### 3. Database Configuration

Update `.env` file with your configuration:

```env
# Database
DATABASE_URL=postgresql://username:password@localhost:5432/revpay_etims_db
REDIS_URL=redis://localhost:6379/0

# KRA Configuration
KRA_SANDBOX_BASE_URL=https://etims-api-sbx.kra.go.ke
KRA_PROD_BASE_URL=https://etims-api.kra.go.ke
KRA_ENVIRONMENT=sandbox

# Security (generated by revpay_init_system)
ENCRYPTION_KEY=your-generated-encryption-key
SECRET_KEY=your-django-secret-key

# Email Configuration (for notifications)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=notifications@revpayconnect.com
EMAIL_HOST_PASSWORD=your-email-password

# Revpay Connect Branding
COMPANY_NAME=Revpay Connect Ltd
SUPPORT_EMAIL=support@revpayconnect.com
SYSTEM_URL=https://gateway.revpayconnect.com
```

### 4. Database Migration

```bash
python manage.py makemigrations
python manage.py migrate
```

### 5. Start Services

```bash
# Start Django development server
python manage.py runserver

# In separate terminals:
# Start Celery worker for async tasks
celery -A etims_integration worker --loglevel=info

# Start Celery beat scheduler for periodic tasks
celery -A etims_integration beat --loglevel=info
```

## ğŸ³ Docker Setup

```bash
# Start all services
docker-compose up -d

# View logs
docker-compose logs -f

# Stop services
docker-compose down
```

## ğŸ“¡ API Endpoints

### ğŸ¢ Client Onboarding
- `POST /api/onboard/` - Register new client company with automatic device setup
- `GET /api/companies/` - List all companies (admin)
- `GET /api/companies/{id}/` - Get company details
- `PUT /api/companies/{id}/status/` - Update company status
- `POST /api/companies/{id}/devices/` - Register additional device

### ğŸ“Š Analytics & Monitoring
- `GET /api/analytics/company/{id}/` - Company-specific analytics dashboard
- `GET /api/analytics/system/` - System-wide analytics dashboard
- `GET /api/logs/` - API logs with filtering and pagination
- `GET /api/compliance/reports/` - List compliance reports
- `POST /api/compliance/generate/` - Generate compliance report
- `GET /api/notifications/` - Notification history

### ğŸ”— OSCU & VSCU Integration APIs
- `POST /api/integration/oscu/sales/` - Process OSCU (physical device) transaction
- `POST /api/integration/vscu/sales/` - Process VSCU (virtual device) transaction
- `GET /api/integration/transactions/{id}/status/` - Get transaction status
- `POST /api/integration/items/sync/` - Sync item catalog
- `GET /api/integration/companies/{id}/devices/` - Get company devices (OSCU & VSCU)
- `GET /api/integration/companies/{id}/items/` - Get company items
- `POST /api/integration/webhook/` - Webhook endpoint for external notifications
- `GET /api/integration/capabilities/` - Get integrator capabilities and supported systems

### ğŸ”„ Environment Management
- `GET /api/environment/status/` - Get current environment status
- `POST /api/environment/switch/` - Switch between sandbox/production
- `GET /api/environment/kra-endpoints/` - Get KRA API endpoints
- `POST /api/environment/test-connectivity/` - Test KRA connectivity

### ğŸ” Legacy eTIMS Core (Backward Compatibility)
- `POST /api/device/init/` - Initialize device with KRA
- `GET /api/device/{id}/status/` - Check device status
- `POST /api/sales/` - Process sales transaction
- `GET /api/invoices/` - List invoices with filtering
- `POST /api/item/sync/` - Sync items with KRA
- `GET /health/` - System health check

## ğŸ§ª Testing with Postman

1. Import the Postman collection: `postman/eTIMS_OSCU_Integration.postman_collection.json`
2. Import the environment: `postman/eTIMS_Environment.postman_environment.json`
3. Update the `auth_token` variable with your Django auth token
4. Run the collection to test all endpoints

### Getting Auth Token

```bash
# Create user and get token via Django shell
python manage.py shell

from django.contrib.auth.models import User
from rest_framework.authtoken.models import Token

user = User.objects.create_user('testuser', 'test@example.com', 'password123')
token = Token.objects.create(user=user)
print(f"Token: {token.key}")
```

## ğŸ”§ Configuration

### KRA Environment Settings

For **Sandbox Testing**:
```env
KRA_ENVIRONMENT=sandbox
KRA_SANDBOX_BASE_URL=https://etims-api-sbx.kra.go.ke
```

For **Production**:
```env
KRA_ENVIRONMENT=production
KRA_PROD_BASE_URL=https://etims-api.kra.go.ke
```

### Celery Task Configuration

Key async tasks:
- `retry_sales_invoice` - Retry failed transactions
- `sync_device_status` - Periodic device health checks
- `cleanup_old_logs` - Database maintenance
- `generate_daily_report` - Transaction reporting

## ğŸ“Š Monitoring

### Health Check
```bash
curl http://localhost:8000/health/
```

### API Logs
Access Django admin at `http://localhost:8000/admin/` to view:
- Device registrations
- Transaction logs
- API call history
- Retry queue status

## ğŸ”’ Security

- Token-based authentication for all API endpoints
- Request rate limiting via Nginx
- SQL injection protection via Django ORM
- CORS configuration for cross-origin requests
- Audit logging for compliance

## ğŸ“ˆ Performance

- Connection pooling for database efficiency
- Redis caching for frequently accessed data
- Async processing for non-blocking operations
- Horizontal scaling support with load balancer

## ğŸš¨ Error Handling

The system implements comprehensive error handling:

1. **Validation Errors**: Client-side data validation
2. **Network Errors**: Automatic retry with exponential backoff
3. **KRA Service Errors**: Graceful degradation and queuing
4. **Database Errors**: Transaction rollback and recovery

## ğŸ“‹ KRA Integration Flow

### Device Registration
1. POST device details to `/api/device/init/`
2. System calls KRA `/selectInitOsdcInfo`
3. CMC key stored securely
4. Device marked as active

### Sales Transaction
1. POST transaction to `/api/sales/`
2. System builds KRA-compliant payload
3. Calls KRA `/saveTrnsSalesOsdc`
4. Stores receipt signature and internal data
5. Returns signed receipt to POS

### Error Recovery
1. Failed transactions enter retry queue
2. Celery workers process retries with backoff
3. Admin alerts for permanent failures
4. Complete audit trail maintained

## ğŸ”„ Deployment

### Production Checklist

- [ ] Update `SECRET_KEY` in production
- [ ] Set `DEBUG=False`
- [ ] Configure proper database credentials
- [ ] Set up SSL certificates
- [ ] Configure monitoring and alerting
- [ ] Set up backup procedures
- [ ] Review security settings

### Environment Variables

Required for production:
```env
SECRET_KEY=your-production-secret-key
DEBUG=False
ALLOWED_HOSTS=your-domain.com
DATABASE_URL=postgresql://user:pass@host:port/db
REDIS_URL=redis://host:port/db
```

## ğŸš€ Getting Started Guide

### For New Clients - Choose Your Integration Path

#### ğŸ–¥ï¸ OSCU Integration (Physical Devices)
**Best for**: Retail stores, restaurants, physical POS systems
1. **System Setup**: Follow the Quick Setup guide above
2. **Company Onboarding**: Use `POST /api/onboard/` with `device_type: "oscu"`
3. **Physical Device Setup**: Install and configure your OSCU hardware
4. **POS Integration**: Connect your POS system using OSCU API endpoints
5. **Testing**: Complete sandbox testing with physical receipts
6. **Go Live**: Switch to production environment

#### â˜ï¸ VSCU Integration (Virtual Devices)
**Best for**: E-commerce, mobile apps, SaaS platforms, API integrations
1. **System Setup**: Follow the Quick Setup guide above
2. **Company Onboarding**: Use `POST /api/onboard/` with `device_type: "vscu"`
3. **API Integration**: Implement VSCU API endpoints in your application
4. **Webhook Setup**: Configure webhooks for real-time notifications (optional)
5. **Testing**: Complete sandbox testing with virtual transactions
6. **Go Live**: Switch to production environment

#### ğŸ”„ Hybrid Integration (Both OSCU & VSCU)
**Best for**: Multi-channel businesses with both physical and online presence
1. **Multi-Device Onboarding**: Register both OSCU and VSCU devices
2. **Unified Dashboard**: Monitor all channels through single interface
3. **Cross-Channel Reporting**: Consolidated compliance and analytics
4. **Flexible Scaling**: Add more devices as business grows

### For Developers

1. **API Documentation**: All endpoints include detailed request/response examples
2. **Postman Collection**: Import and test all endpoints easily
3. **Management Commands**: Use `revpay_status_check` for system monitoring
4. **Analytics Dashboard**: Monitor your integration performance
5. **Webhook Integration**: Receive real-time notifications

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   POS/ERP       â”‚    â”‚  Revpay Connect  â”‚    â”‚   KRA eTIMS     â”‚
â”‚   Systems       â”‚â—„â”€â”€â–ºâ”‚     Gateway      â”‚â—„â”€â”€â–ºâ”‚     OSCU        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Multi-Tenant   â”‚
                    â”‚    Database      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Analytics &      â”‚
                    â”‚ Compliance       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Management Commands

### System Administration
```bash
# Initialize system with admin user and encryption
python manage.py revpay_init_system --admin-email admin@yourcompany.com

# Run comprehensive system health check
python manage.py revpay_status_check --send-alerts --verbose

# Setup periodic monitoring tasks
python manage.py setup_celery_beat --clear-existing
```

### Monitoring & Maintenance
```bash
# Check system status
python manage.py revpay_status_check

# Generate compliance reports
python manage.py shell -c "from kra_oscu.tasks import generate_compliance_reports; generate_compliance_reports.delay()"

# Clean old data
python manage.py shell -c "from kra_oscu.tasks import cleanup_old_data; cleanup_old_data.delay()"
```

## ğŸ”” Notification Channels

The system supports multiple notification channels:

- **Email**: Professional branded templates for client communications
- **Webhooks**: Real-time HTTP callbacks for external systems
- **SMS**: Text message alerts for critical issues (via third-party providers)
- **System Alerts**: In-dashboard notifications for administrators

## ğŸ“ˆ Compliance & Analytics

### Automated Reports
- **Daily Transaction Reports**: Automatic generation and delivery
- **Compliance Summaries**: KRA submission status and error analysis
- **Performance Metrics**: Response times, success rates, and system health
- **Device Monitoring**: Uptime tracking and offline alerts

### Business Intelligence
- **Revenue Analytics**: Transaction volume and value trends
- **Tax Compliance**: VAT calculations and submission tracking
- **Device Performance**: Individual device statistics and health
- **Error Analysis**: Failure patterns and resolution tracking

## ğŸ“ Support & Contact

### Revpay Connect Ltd
- **Website**: [https://revpayconnect.com](https://revpayconnect.com)
- **Email**: support@revpayconnect.com
- **Technical Support**: tech@revpayconnect.com
- **Sales Inquiries**: sales@revpayconnect.com
- **Phone**: +254 700 000 000

### Documentation & Resources
- **API Documentation**: Available in Django admin and `/docs/` directory
- **Integration Guides**: Step-by-step setup for popular POS systems
- **Compliance Resources**: KRA eTIMS requirements and best practices
- **Developer Portal**: [https://developers.revpayconnect.com](https://developers.revpayconnect.com)

### Emergency Support
For critical production issues:
- **24/7 Hotline**: +254 700 000 001
- **Emergency Email**: emergency@revpayconnect.com
- **Status Page**: [https://status.revpayconnect.com](https://status.revpayconnect.com)

## ğŸ“„ License & Legal

This software is proprietary to **Revpay Connect Ltd** and is licensed for use under our Terms of Service. 

### Compliance Notice
This system is certified for KRA eTIMS OSCU integration in Kenya. All implementations must:
- Obtain proper KRA certification before production use
- Comply with Kenya Revenue Authority tax regulations
- Maintain audit trails as required by law
- Ensure data security and privacy compliance

### Data Protection
Revpay Connect Gateway implements GDPR-compliant data handling:
- Encryption of sensitive data at rest and in transit
- Audit logging of all data access and modifications
- Right to data portability and deletion
- Regular security assessments and updates

---

**Â© 2024 Revpay Connect Ltd. All rights reserved.**

*Empowering businesses across Kenya with seamless tax compliance automation.*
